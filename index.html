<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數24 錦標賽 (Math 24 Esports)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Scrollbar Style -->
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.8);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 1);
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        @keyframes stamp-in {
            0% { transform: scale(3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-stamp {
            animation: stamp-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes pop-in {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>

    <!-- Import Map for React & Firebase modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen overflow-x-hidden">
    <div id="root"></div>

    <!-- 注意這裡加入了 type="text/babel" 和 data-type="module" 以支援 JSX 和 Imports -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            increment, 
            deleteDoc, 
            serverTimestamp,
            arrayUnion 
        } from 'firebase/firestore';

        // --- Icons (Inlined for single-file stability) ---
        const Icon = ({ path, className, fill = "none" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill={fill} stroke="currentColor" 
                strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const LucideGamepad2 = (props) => <Icon {...props} path={<><line x1="6" x2="10" y1="12" y2="12"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="15" x2="15.01" y1="13" y2="13"/><line x1="18" x2="18.01" y1="11" y2="11"/><rect width="20" height="12" x="2" y="6" rx="2"/></>} />;
        const LucideUsers = (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
        const LucideTimer = (props) => <Icon {...props} path={<><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></>} />;
        const LucideCalculator = (props) => <Icon {...props} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />;
        const LucideTrophy = (props) => <Icon {...props} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>} />;
        const LucideXCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const LucideCheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const LucidePlay = (props) => <Icon {...props} path={<><polygon points="6 3 20 12 6 21 6 3"/></>} />;
        const LucideCrown = (props) => <Icon {...props} fill="currentColor" path={<><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></>} />;
        const LucideZap = (props) => <Icon {...props} fill="currentColor" path={<><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></>} />;
        const LucideHistory = (props) => <Icon {...props} path={<><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></>} />;
        const LucideVolume2 = (props) => <Icon {...props} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></>} />;
        const LucideVolumeX = (props) => <Icon {...props} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></>} />;
        const LucideWifi = (props) => <Icon {...props} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />;
        const LucideWifiOff = (props) => <Icon {...props} path={<><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />;

        // --- Firebase Configuration ---
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCqY2j1mjd7TmSNz7KuaNcHNU_ED9zBNHw",
            authDomain: "math24-60417.firebaseapp.com",
            databaseURL: "https://math24-60417-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "math24-60417",
            storageBucket: "math24-60417.firebasestorage.app",
            messagingSenderId: "56193320606",
            appId: "1:56193320606:web:f8636a4e6bad5cc2131d8f",
            measurementId: "G-WM1S25FH4W"
        };
        
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
             firebaseConfig = JSON.parse(__firebase_config);
        } else {
             firebaseConfig = defaultFirebaseConfig;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Game Logic ---
        const SUITS = ['♠', '♥', '♣', '♦'];
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const VALUES = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];

        // 使用免費的 Mixkit 音效連結
        const SOUND_URLS = {
            start: 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.m4a', // Whoosh
            tick: 'https://assets.mixkit.co/active_storage/sfx/2587/2587-preview.m4a',  // Clock tick
            buzz: 'https://assets.mixkit.co/active_storage/sfx/2863/2863-preview.m4a',  // Alarm
            correct: 'https://assets.mixkit.co/active_storage/sfx/270/270-preview.m4a', // Ding
            wrong: 'https://assets.mixkit.co/active_storage/sfx/2880/2880-preview.m4a', // Error buzz
            click: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a', // Pop click
            card: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.m4a',  // Soft tap
            win: 'https://assets.mixkit.co/active_storage/sfx/2015/2015-preview.m4a',   // Win chime
        };

        const useAudio = () => {
            const audioRefs = useRef({});
            const [isMuted, setIsMuted] = useState(false);

            useEffect(() => {
                // Initialize Audio objects
                Object.keys(SOUND_URLS).forEach(key => {
                    const audio = new Audio(SOUND_URLS[key]);
                    audio.preload = 'auto';
                    audioRefs.current[key] = audio;
                });
            }, []);

            const playSound = useCallback((soundName) => {
                if (isMuted) return;
                
                const audio = audioRefs.current[soundName];
                if (audio) {
                    audio.currentTime = 0; // Rewind to start
                    audio.volume = 0.5;
                    // Catch promise to avoid "play() failed because the user didn't interact" errors
                    audio.play().catch(e => {
                        // Silent fail if browser blocks auto-play before interaction
                        console.warn("Audio blocked:", e); 
                    });
                }
            }, [isMuted]);

            return { playSound, isMuted, setIsMuted };
        };

        const generateDeck = () => {
            const deck = [];
            for (let i = 0; i < 52; i++) deck.push(i);
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        };

        const getCardDetails = (cardId) => {
            if (cardId === null || cardId === undefined) return { rank: '?', suit: '?', value: 0, color: 'black' };
            const suitIndex = Math.floor(cardId / 13);
            const rankIndex = cardId % 13;
            return {
                rank: RANKS[rankIndex],
                suit: SUITS[suitIndex],
                value: VALUES[rankIndex],
                color: (suitIndex === 1 || suitIndex === 3) ? 'text-red-600' : 'text-slate-900',
                fullLabel: `${SUITS[suitIndex]}${RANKS[rankIndex]}`
            };
        };

        const evaluateExpression = (expr) => {
            try {
                if (/[^0-9+\-*/().\s]/.test(expr)) return null;
                const result = Function(`"use strict"; return (${expr})`)();
                return result;
            } catch (e) { return null; }
        };

        // Helper to format text for display
        const formatToken = (text) => {
            if (text === '*') return '×';
            if (text === '/') return '÷';
            return text;
        };

        // --- Result Animation Component ---
        const RoundResultOverlay = ({ result, playSound }) => {
            const [showTokens, setShowTokens] = useState([]);
            
            useEffect(() => {
                if (!result || !result.expression) return;
                
                // Play result sound immediately
                if(result.result === 'Success') playSound('correct');
                else if(result.result === 'Impossible') playSound('wrong'); // Use wrong sound for impossible for now
                else playSound('wrong');

                const tokens = result.expression.split(' ');
                let current = 0;
                
                // Use CSS delays, but we need to mount them to trigger animations
                // Here we just set the tokens, the CSS handles delay
                setShowTokens(tokens);

            }, [result]);

            if (!result) return null;

            return (
                <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-950/90 backdrop-blur-md animate-in fade-in duration-300">
                    <div className="text-center">
                        <h2 className="text-3xl font-black italic text-blue-300 mb-8 tracking-widest uppercase drop-shadow-lg">
                            {result.result === 'Success' ? '精彩重播' : '回合結束'}
                        </h2>
                        
                        {/* Cards Display */}
                        <div className="flex gap-4 mb-10 justify-center">
                            {result.cards && result.cards.map((c, i) => {
                                 const { rank, suit, color } = getCardDetails(c);
                                 const isRed = color.includes('red');
                                 return (
                                     <div key={i} className={`
                                        w-16 h-24 bg-white rounded-lg shadow-xl flex flex-col items-center justify-center text-3xl font-serif
                                        ${isRed ? 'text-red-600' : 'text-slate-900'}
                                        animate-[pop-in_0.5s_ease-out_forwards]
                                     `} style={{ animationDelay: `${i * 0.1}s` }}>
                                         <div className="text-sm absolute top-1 left-1">{rank}</div>
                                         {suit}
                                     </div>
                                 )
                            })}
                        </div>

                        <div className="text-xl text-slate-400 mb-4 font-bold">
                            {result.playerName}
                        </div>

                        {result.result === 'Impossible' ? (
                             <div className="text-4xl font-mono text-slate-500 font-bold mb-8">無解 (No Solution)</div>
                        ) : result.result === 'RoundTimeout' ? (
                             <div className="text-4xl font-mono text-slate-500 font-bold mb-8">時間到 (Time Up)</div>
                        ) : (
                             <div className="h-16 flex items-center justify-center flex-wrap gap-2 mb-8 max-w-4xl px-4">
                                 {showTokens.map((t, i) => {
                                     // Determine if token is operator or number for styling to match input interface
                                     const isOp = ['+', '-', '*', '×', '/', '÷', '(', ')'].includes(formatToken(t));
                                     return (
                                         <span key={i} className={`
                                            px-3 py-1 rounded-lg shadow-lg border-2 text-2xl md:text-3xl font-black font-mono 
                                            opacity-0 animate-[pop-in_0.2s_ease-out_forwards]
                                            ${isOp 
                                                ? 'bg-blue-900/80 text-blue-300 border-blue-700' 
                                                : 'bg-slate-200 text-slate-900 border-slate-400 font-serif'}
                                         `} style={{ animationDelay: `${0.5 + i * 0.2}s` }}>
                                             {formatToken(t)}
                                         </span>
                                     )
                                 })}
                                 {showTokens.length > 0 && (
                                     <span className="text-3xl md:text-4xl font-black text-yellow-400 opacity-0 animate-[pop-in_0.2s_ease-out_forwards] ml-2 mt-1"
                                           style={{ animationDelay: `${0.5 + showTokens.length * 0.2}s` }}>
                                         = 24
                                     </span>
                                 )}
                             </div>
                        )}

                        <div className="relative h-24 flex items-center justify-center opacity-0 animate-[stamp-in_0.3s_cubic-bezier(0.175,0.885,0.32,1.275)_forwards]" style={{ animationDelay: `${1.5 + (showTokens.length || 0) * 0.2}s` }}>
                             {result.result === 'Success' && (
                                 <div className="text-6xl font-black text-green-500 border-8 border-green-500 rounded-xl px-8 py-2 -rotate-12 drop-shadow-[0_0_20px_rgba(34,197,94,0.6)]">
                                     CORRECT
                                 </div>
                             )}
                             {(result.result === 'Wrong' || result.result === 'Timeout') && (
                                 <div className="text-6xl font-black text-red-500 border-8 border-red-500 rounded-xl px-8 py-2 rotate-12 drop-shadow-[0_0_20px_rgba(239,68,68,0.6)]">
                                     FAIL
                                 </div>
                             )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        function Math24Game() {
            const [user, setUser] = useState(null);
            const [userName, setUserName] = useState('');
            const [currentView, setCurrentView] = useState('login');
            const [roomId, setRoomId] = useState(null);
            const [roomList, setRoomList] = useState([]);
            const [roomData, setRoomData] = useState(null);
            
            // Connection Status State
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [authError, setAuthError] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(true);

            // Ref to track latest roomData for closure access
            const roomDataRef = useRef(null);
            
            const [expression, setExpression] = useState([]);
            const [usedCardIndices, setUsedCardIndices] = useState([]);
            const [timeLeft, setTimeLeft] = useState(0);
            const [totalTime, setTotalTime] = useState(60);

            const { playSound, isMuted, setIsMuted } = useAudio();
            const lastPlayedTickRef = useRef(null);

            // Network Monitoring
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Auth
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed:", err);
                        setAuthError(err.message || "連線失敗，請檢查網路設定");
                        setIsAuthLoading(false);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setIsAuthLoading(false);
                    if(u) setAuthError(null); // Clear error on success
                });
                return () => unsubscribe();
            }, []);

            // Room List
            useEffect(() => {
                if (!user || currentView !== 'lobby') return;
                const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'math24_rooms');
                const unsub = onSnapshot(roomsRef, (snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'lobby' && Object.keys(data.players || {}).length < 4) {
                            list.push({ id: doc.id, ...data });
                        }
                    });
                    setRoomList(list);
                }, (error) => {
                    console.error("Room list error:", error);
                    // Optionally handle permission errors here
                });
                return () => unsub();
            }, [user, currentView]);

            // Room Sync
            useEffect(() => {
                if (!user || !roomId) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);
                const unsub = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setRoomData(data);
                        roomDataRef.current = data; // Keep ref updated

                        if (!data.players || !data.players[user.uid]) {
                            alert('您已離開房間');
                            setRoomId(null);
                            setCurrentView('lobby');
                            return;
                        }
                        handleTimerSync(data);
                    } else {
                        setRoomId(null);
                        setCurrentView('lobby');
                    }
                }, (error) => {
                    console.error("Room sync error:", error);
                });
                return () => unsub();
            }, [roomId, user]);

            // Audio Side Effects
            useEffect(() => {
                if (roomData?.status === 'playing') playSound('start');
                if (roomData?.status === 'finished') playSound('win');
            }, [roomData?.status]);

            useEffect(() => {
                if (roomData?.gameState?.buzzerId) playSound('buzz');
            }, [roomData?.gameState?.buzzerId]);

            // Timer
            const timerRef = useRef(null);
            const handleTimerSync = (data) => {
                if (timerRef.current) clearInterval(timerRef.current);
                if (data.status === 'playing') {
                    const isBuzzerPhase = !!data.gameState.buzzerId;
                    setTotalTime(isBuzzerPhase ? 15 : 60); // 這裡改為 15 秒
                    timerRef.current = setInterval(() => {
                        const now = Date.now();
                        let targetTime = isBuzzerPhase ? data.gameState.buzzerEndTime : data.gameState.roundEndTime;
                        const diff = Math.max(0, Math.ceil((targetTime - now) / 1000));
                        setTimeLeft(diff);
                        if (diff > 0 && diff <= 10 && lastPlayedTickRef.current !== diff) {
                            playSound('tick');
                            lastPlayedTickRef.current = diff;
                        }
                        if (diff <= 0 && data.hostId === user.uid) {
                           handleTimeOut(data); // Pass snapshot data
                        }
                    }, 1000);
                }
            };
            
            const handleTimeOut = async (data) => {
                clearInterval(timerRef.current);
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);
                if (data.gameState.buzzerId) {
                    // Buzz Timeout
                    await updateScoreAndNextRound(roomRef, data.gameState.buzzerId, -1, "超時未作答", "Timeout");
                } else {
                    // Round Timeout (nobody answered)
                    const currentData = roomDataRef.current || data;
                    const historyEntry = {
                        round: currentData.gameState.round || 1,
                        cards: currentData.gameState.currentCards,
                        playerName: "-",
                        expression: "Time Up",
                        result: "RoundTimeout",
                        timestamp: Date.now()
                    };
                    await updateDoc(roomRef, {
                        'gameState.lastRoundResult': historyEntry,
                        'gameState.history': arrayUnion(historyEntry),
                        'status': 'resolving'
                    });
                    setTimeout(() => {
                         const d = roomDataRef.current?.gameState?.deck || [];
                         startNewRound(roomRef, d);
                    }, 4000);
                }
            };

            // Actions
            const createRoom = async (name, password) => {
                playSound('click');
                if (!name) return;
                const newRoomRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'math24_rooms'));
                const initialData = {
                    name, password, hostId: user.uid, status: 'lobby', createdAt: serverTimestamp(),
                    players: { [user.uid]: { id: user.uid, name: userName, score: 2, ready: false, status: 'online' } },
                    gameState: { round: 0, deck: [], currentCards: [], buzzerId: null, impossibleVotes: [], history: [] }
                };
                await setDoc(newRoomRef, initialData);
                setRoomId(newRoomRef.id);
                setCurrentView('room');
            };

            const joinRoom = async (room) => {
                playSound('click');
                if (room.password && prompt("請輸入房間密碼:") !== room.password) { alert("密碼錯誤"); return; }
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', room.id);
                await updateDoc(roomRef, { [`players.${user.uid}`]: { id: user.uid, name: userName, score: 2, ready: false, status: 'online' } });
                setRoomId(room.id);
                setCurrentView('room');
            };

            const toggleReady = async () => {
                playSound('click');
                if (!roomId) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);
                await updateDoc(roomRef, { [`players.${user.uid}.ready`]: !roomData.players[user.uid].ready });
            };

            const startGame = async () => {
                playSound('click');
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);
                await startNewRound(roomRef, generateDeck(), true);
            };

            const startNewRound = async (roomRef, deckToUse, resetScores = false) => {
                // Use ref for latest data check
                const currentData = roomDataRef.current || roomData;
                
                if (!resetScores && currentData) {
                    const winner = Object.values(currentData.players).find(p => p.score >= 10);
                    const loser = Object.values(currentData.players).find(p => p.score <= 0);
                    if (winner || loser) { await updateDoc(roomRef, { status: 'finished' }); return; }
                }
                let currentDeck = [...deckToUse];
                if (currentDeck.length < 4) currentDeck = generateDeck();
                const cards = [currentDeck.pop(), currentDeck.pop(), currentDeck.pop(), currentDeck.pop()];
                await updateDoc(roomRef, {
                    'gameState.round': increment(1),
                    'gameState.deck': currentDeck, 'gameState.currentCards': cards, 'gameState.roundEndTime': Date.now() + 60000,
                    'gameState.buzzerId': null, 'gameState.buzzerEndTime': null, 'gameState.impossibleVotes': [], status: 'playing'
                });
            };

            const leaveRoom = async () => {
                playSound('click');
                if (!roomId) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);
                if (Object.keys(roomData.players).length <= 1) { await deleteDoc(roomRef); } else {
                    const newPlayers = { ...roomData.players }; delete newPlayers[user.uid];
                    let newHostId = roomData.hostId === user.uid ? Object.keys(newPlayers)[0] : roomData.hostId;
                    await updateDoc(roomRef, { players: newPlayers, hostId: newHostId });
                }
                setRoomId(null); setCurrentView('lobby');
            };

            const buzz = async () => {
                // Note: sound is handled by useEffect listener on gameState.buzzerId
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);
                if (roomData.gameState.buzzerId) return;
                try {
                    // 這裡改為 15000 (15秒)
                    await updateDoc(roomRef, { 'gameState.buzzerId': user.uid, 'gameState.buzzerEndTime': Date.now() + 15000 });
                    setExpression([]); setUsedCardIndices([]);
                } catch (e) { console.error("搶答失敗", e); }
            };

            const submitAnswer = async () => {
                if (expression.length === 0) return;
                const exprStr = expression.map(t => t.val).join(' ');
                // Ensure display expression uses nice operators
                const displayExpr = expression.map(t => t.label).join(' ');

                const result = evaluateExpression(exprStr);
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);

                if (Math.abs(result - 24) < 0.0001 && usedCardIndices.length === 4) {
                    await updateScoreAndNextRound(roomRef, user.uid, 1, displayExpr, "Success");
                } else {
                    await updateScoreAndNextRound(roomRef, user.uid, -1, displayExpr, "Wrong");
                }
            };

            const updateScoreAndNextRound = async (roomRef, playerId, scoreDelta, expressionStr, resultStatus) => {
                // Use Ref to access latest data inside timer closures
                const currentData = roomDataRef.current;
                if (!currentData) return;

                const currentScore = currentData.players[playerId]?.score || 0;
                const newScore = currentScore + scoreDelta;
                const isGameOver = newScore >= 10 || newScore <= 0;

                const historyEntry = {
                    round: currentData.gameState.round || 1,
                    cards: currentData.gameState.currentCards,
                    playerName: currentData.players[playerId].name,
                    expression: expressionStr,
                    result: resultStatus, // "Success", "Wrong", "Timeout"
                    timestamp: Date.now()
                };

                if (isGameOver) {
                    await updateDoc(roomRef, { 
                        [`players.${playerId}.score`]: increment(scoreDelta),
                        'gameState.buzzerId': null,
                        'status': 'finished',
                        'gameState.history': arrayUnion(historyEntry)
                    });
                } else {
                    await updateDoc(roomRef, { 
                        [`players.${playerId}.score`]: increment(scoreDelta),
                        'gameState.buzzerId': null,
                        'status': 'resolving',
                        'gameState.history': arrayUnion(historyEntry),
                        'gameState.lastRoundResult': historyEntry
                    });
                    
                    setTimeout(() => { 
                        const currentDeck = roomDataRef.current?.gameState?.deck || [];
                        startNewRound(roomRef, currentDeck); 
                    }, 4000);
                }
            };

            const voteImpossible = async () => {
                playSound('click');
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'math24_rooms', roomId);
                const votes = roomData.gameState.impossibleVotes || [];
                if (votes.includes(user.uid)) return;
                const newVotes = [...votes, user.uid];
                
                if (newVotes.length >= Object.keys(roomData.players).length) {
                     const historyEntry = {
                        round: roomData.gameState.round || 1,
                        cards: roomData.gameState.currentCards,
                        playerName: "全體投票",
                        expression: "無解",
                        result: "Impossible",
                        timestamp: Date.now()
                    };
                    await updateDoc(roomRef, { 
                        'gameState.history': arrayUnion(historyEntry),
                        'gameState.lastRoundResult': historyEntry,
                        'status': 'resolving'
                    });
                    setTimeout(() => startNewRound(roomRef, roomData.gameState.deck), 4000);
                } else { 
                    await updateDoc(roomRef, { 'gameState.impossibleVotes': newVotes }); 
                }
            };

            // --- Top Bar with Controllers ---
            const TopBar = () => (
                <div className="fixed top-4 right-4 z-50 flex items-center gap-2">
                    {/* Connection Status */}
                    <div className={`
                        flex items-center gap-1 px-3 py-1.5 rounded-full border text-xs font-bold transition-all shadow-md
                        ${isOnline && !authError ? 'bg-slate-800/80 text-green-400 border-green-800' : 'bg-red-900/80 text-white border-red-500 animate-pulse'}
                    `} title={isOnline ? "已連線" : "連線中斷"}>
                        {isOnline && !authError ? <LucideWifi className="w-4 h-4"/> : <LucideWifiOff className="w-4 h-4"/>}
                        <span className="hidden md:inline">{isOnline ? (authError ? "連線錯誤" : "ONLINE") : "OFFLINE"}</span>
                    </div>

                    {/* Sound Toggle */}
                    <button 
                        onClick={() => setIsMuted(!isMuted)}
                        className="bg-slate-800/80 p-2 rounded-full text-slate-300 hover:text-white hover:bg-slate-700 transition border border-slate-600 shadow-md"
                        title={isMuted ? "開啟音效" : "靜音"}
                    >
                        {isMuted ? <LucideVolumeX className="w-5 h-5"/> : <LucideVolume2 className="w-5 h-5"/>}
                    </button>
                </div>
            );

            // --- Views ---

            // Login
            if (currentView === 'login') {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800 to-slate-950">
                        <div className="bg-slate-800/80 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-md text-center border border-slate-700 relative">
                            {/* Error Banner */}
                            {authError && (
                                <div className="absolute -top-16 left-0 right-0 bg-red-600 text-white p-3 rounded-xl shadow-lg animate-bounce text-sm font-bold flex items-center justify-center gap-2">
                                    <LucideWifiOff className="w-5 h-5"/> {authError}
                                </div>
                            )}

                            <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-400 mb-8 flex items-center justify-center gap-3 italic">
                                <LucideGamepad2 className="w-12 h-12 text-yellow-400" /> 數24 錦標賽
                            </h1>
                            
                            {isAuthLoading ? (
                                <div className="py-12 flex flex-col items-center gap-4 text-blue-300">
                                    <div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="font-bold tracking-widest animate-pulse">連線伺服器中...</span>
                                </div>
                            ) : (
                                <>
                                    <input type="text" placeholder="輸入選手代號 (暱稱)" className="w-full p-4 text-xl bg-slate-950 border-2 border-slate-600 text-white rounded-xl mb-6 focus:outline-none focus:border-yellow-500 transition text-center placeholder-slate-500" value={userName} onChange={(e) => setUserName(e.target.value)} />
                                    <button onClick={() => { if (userName.trim()) { playSound('click'); setCurrentView('lobby'); }}} disabled={!userName.trim() || !isOnline} className="w-full bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-bold py-4 rounded-xl text-2xl transition disabled:opacity-50 shadow-lg shadow-blue-900/50 border border-blue-500">
                                        進入賽事大廳
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            // Lobby
            if (currentView === 'lobby') {
                return (
                    <div className="min-h-screen bg-slate-900 text-white p-4 md:p-8 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black">
                        <TopBar />
                        <div className="max-w-5xl mx-auto">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                                <h2 className="text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-300 flex items-center gap-2">
                                    <LucideTrophy className="w-10 h-10 text-yellow-400"/> 賽事大廳
                                </h2>
                                <div className="text-blue-300 font-medium bg-slate-800 px-6 py-2 rounded-full border border-blue-900 flex items-center gap-2 shadow-md">
                                    <span className="text-slate-400">選手:</span> <span className="text-yellow-400 font-bold text-lg">{userName}</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="bg-slate-800/60 backdrop-blur p-6 rounded-2xl shadow-xl border border-slate-700 relative overflow-hidden group">
                                    <div className="absolute inset-0 bg-gradient-to-br from-blue-600/10 to-purple-600/10 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                                    <h3 className="text-2xl font-bold mb-6 text-blue-400 flex items-center gap-2 relative z-10"><LucidePlay className="w-6 h-6"/> 創建對戰房間</h3>
                                    <form onSubmit={(e) => { e.preventDefault(); createRoom(e.target.roomName.value, e.target.roomPass.value); }} className="relative z-10">
                                        <input name="roomName" placeholder="房間名稱" required className="w-full p-4 bg-slate-950 border border-slate-600 rounded-xl mb-4 text-white placeholder-slate-500 focus:border-yellow-500 focus:outline-none" />
                                        <input name="roomPass" placeholder="密碼 (選填)" className="w-full p-4 bg-slate-950 border border-slate-600 rounded-xl mb-6 text-white placeholder-slate-500 focus:border-yellow-500 focus:outline-none" />
                                        <button type="submit" className="w-full bg-gradient-to-r from-yellow-500 to-yellow-700 text-slate-900 py-4 rounded-xl font-black text-xl hover:from-yellow-400 hover:to-yellow-600 transition shadow-lg shadow-yellow-900/30 border border-yellow-400">建立並加入賽局</button>
                                    </form>
                                </div>
                                <div className="bg-slate-800/60 backdrop-blur p-6 rounded-2xl shadow-xl border border-slate-700 relative overflow-hidden">
                                    <h3 className="text-2xl font-bold mb-6 text-blue-400 flex items-center gap-2"><LucideUsers className="w-6 h-6"/> 進行中賽局</h3>
                                    <div className="space-y-3 h-[28rem] overflow-y-auto pr-2 custom-scrollbar">
                                        {roomList.length === 0 ? (
                                            <div className="text-slate-500 text-center py-12 flex flex-col items-center"><LucideGamepad2 className="w-16 h-16 mb-4 opacity-50"/><p className="text-xl">目前沒有公開賽局</p></div>
                                        ) : (
                                            roomList.map(room => (
                                                <div key={room.id} className="bg-slate-900/80 border border-slate-700 p-4 rounded-xl flex justify-between items-center hover:border-blue-500 transition group">
                                                    <div>
                                                        <div className="font-bold text-xl text-white group-hover:text-blue-300 transition">{room.name}</div>
                                                        <div className="text-sm text-slate-400 flex items-center gap-2 mt-1"><LucideUsers className="w-4 h-4"/> {Object.keys(room.players || {}).length}/4 位選手 {room.password && <span className="text-yellow-500 text-xs border border-yellow-900 bg-yellow-900/20 px-2 py-0.5 rounded-full">密碼</span>}</div>
                                                    </div>
                                                    <button onClick={() => joinRoom(room)} className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-500 transition shadow-md border border-blue-400">加入</button>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!roomData) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white font-bold text-2xl">載入賽局資料...</div>;

            const isHost = roomData.hostId === user.uid;
            const isPlaying = roomData.status === 'playing';
            const isResolving = roomData.status === 'resolving';
            const isFinished = roomData.status === 'finished';
            const myPlayer = roomData.players[user.uid];
            const buzzerId = roomData.gameState?.buzzerId;
            const iAmBuzzer = buzzerId === user.uid;
            const buzzerPlayer = buzzerId ? roomData.players[buzzerId] : null;

            const Card = ({ cardId, index, onClick, disabled, used }) => {
                const { rank, suit, color } = getCardDetails(cardId);
                const isRed = color.includes('red');
                return (
                    <button onClick={() => { if(onClick && !disabled) { playSound('card'); onClick(index); }}} disabled={disabled || used} className={`relative w-20 h-28 md:w-28 md:h-40 bg-gradient-to-b from-slate-50 to-slate-200 rounded-xl shadow-lg border-2 flex flex-col items-center justify-center text-4xl md:text-5xl font-serif select-none transition-all duration-200 ${isRed ? 'text-red-600 border-red-200' : 'text-slate-900 border-slate-300'} ${used ? 'opacity-40 scale-95 grayscale' : 'hover:-translate-y-2 hover:shadow-2xl hover:border-blue-400 cursor-pointer'} ${disabled && !used ? 'cursor-not-allowed opacity-70' : ''} before:absolute before:inset-0 before:bg-gradient-to-br before:from-white/40 before:to-transparent before:rounded-xl before:pointer-events-none`}>
                        <div className="absolute top-2 left-3 text-lg md:text-xl font-bold">{rank}</div>
                        <div className="text-5xl md:text-6xl drop-shadow-sm">{suit}</div>
                        <div className="absolute bottom-2 right-3 text-lg md:text-xl font-bold transform rotate-180">{rank}</div>
                    </button>
                );
            };

            const CardMini = ({ cardId }) => {
                 const { rank, suit, color } = getCardDetails(cardId);
                 const isRed = color.includes('red');
                 return (
                     <span className={`inline-flex items-center justify-center w-8 h-10 border rounded bg-white text-xs mx-0.5 font-bold ${isRed ? 'text-red-600 border-red-200' : 'text-slate-900 border-slate-300'}`}>
                         {suit}{rank}
                     </span>
                 );
            };

            if (isFinished) {
                const sortedPlayers = Object.values(roomData.players).sort((a, b) => b.score - a.score);
                const history = roomData.gameState.history || [];
                
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 bg-[radial-gradient(ellipse_at_bottom,_var(--tw-gradient-stops))] from-indigo-900 to-slate-950 text-white overflow-y-auto">
                        <TopBar />
                        <div className="bg-slate-800/80 backdrop-blur-xl rounded-3xl p-10 max-w-4xl w-full text-center shadow-2xl border border-slate-600 relative overflow-hidden my-8">
                            <div className="absolute inset-0 bg-gradient-to-b from-yellow-500/10 via-transparent to-transparent opacity-50 pointer-events-none"></div>
                            
                            <LucideTrophy className="w-20 h-20 text-yellow-400 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]" />
                            <h2 className="text-4xl font-black mb-6 italic text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-600">比賽結果</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div className="space-y-3 relative z-10">
                                    <h3 className="text-xl font-bold text-slate-300 mb-2 border-b border-slate-600 pb-2">排行榜</h3>
                                    {sortedPlayers.map((p, idx) => {
                                        let bgColor = 'bg-slate-700/50', borderColor = 'border-slate-600', textColor = 'text-slate-300', rankIcon = null;
                                        if (idx === 0) { bgColor = 'bg-gradient-to-r from-yellow-900/80 to-slate-900/80'; borderColor = 'border-yellow-500'; textColor = 'text-yellow-400'; rankIcon = <LucideCrown className="w-5 h-5 text-yellow-400 fill-yellow-400" />; }
                                        else if (p.score <= 0) { textColor = 'text-red-400'; borderColor = 'border-red-900/50'; }
                                        return (
                                            <div key={p.id} className={`flex justify-between items-center p-4 rounded-xl border-2 ${bgColor} ${borderColor} shadow-md`}>
                                                <div className={`font-bold text-lg flex items-center gap-2 ${idx === 0 ? 'text-white' : 'text-slate-200'}`}><span className="font-mono opacity-50">#{idx + 1}</span>{rankIcon}{p.name}</div>
                                                <div className={`font-black text-2xl font-mono ${textColor}`}>{p.score} <span className="text-xs opacity-70">PTS</span></div>
                                            </div>
                                        )
                                    })}
                                </div>

                                <div className="space-y-3 relative z-10 text-left h-80 overflow-y-auto custom-scrollbar pr-2">
                                     <h3 className="text-xl font-bold text-slate-300 mb-2 border-b border-slate-600 pb-2 flex items-center gap-2"><LucideHistory className="w-5 h-5"/> 比賽回顧</h3>
                                     {history.length === 0 ? <p className="text-slate-500 text-center italic">無紀錄</p> : 
                                        history.map((h, i) => (
                                            <div key={i} className="bg-slate-900/50 p-3 rounded-lg border border-slate-700 text-sm">
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="text-slate-400 font-mono">Round {h.round}</span>
                                                    <span className={`font-bold px-2 py-0.5 rounded text-xs ${h.result === 'Success' ? 'bg-green-900 text-green-300' : h.result === 'Wrong' ? 'bg-red-900 text-red-300' : 'bg-slate-700 text-slate-400'}`}>
                                                        {h.result === 'Success' ? '答對' : h.result === 'Wrong' ? '答錯' : h.result === 'Timeout' ? '超時' : '無解'}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-1 mb-2 bg-slate-800 p-1 rounded justify-center">
                                                    {h.cards && h.cards.map((c, ci) => <CardMini key={ci} cardId={c}/>)}
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-blue-300 font-bold">{h.playerName}</span>
                                                    <span className="font-mono text-slate-200">{formatToken(h.expression)}</span>
                                                </div>
                                            </div>
                                        ))
                                     }
                                </div>
                            </div>
                            
                            <button onClick={leaveRoom} className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl text-xl transition border border-slate-500 relative z-10">離開賽場</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-950 flex flex-col md:flex-row overflow-hidden bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-950/50 via-slate-950 to-black text-slate-100">
                    <TopBar />
                    
                    {/* Render Result Overlay if resolving */}
                    {isResolving && roomData.gameState.lastRoundResult && (
                        <RoundResultOverlay result={roomData.gameState.lastRoundResult} playSound={playSound} />
                    )}

                    <div className="w-full md:w-72 bg-slate-900/90 backdrop-blur-md border-r border-slate-800 p-6 flex flex-col gap-6 shadow-2xl z-10">
                        <div className="mb-2">
                            <h2 className="text-2xl font-black text-white break-all italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-200">{roomData.name}</h2>
                            <p className="text-xs text-slate-500 font-mono mt-1">ROOM ID: {roomId.slice(0,6).toUpperCase()}</p>
                        </div>
                        <div className="flex-1 space-y-4">
                            {Object.values(roomData.players).map(p => {
                                const isLeader = p.score === Math.max(...Object.values(roomData.players).map(pl => pl.score)) && p.score > 2;
                                const isBuzzer = buzzerId === p.id;
                                return (
                                    <div key={p.id} className={`relative p-4 rounded-xl border-2 transition-all duration-300 ${p.ready ? 'border-blue-500/50 bg-blue-950/30' : 'border-slate-700 bg-slate-800/50'} ${isLeader ? 'border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.3)]' : ''} ${isBuzzer ? 'border-red-500 bg-red-950/30 shadow-[0_0_20px_rgba(239,68,68,0.5)] scale-105 z-20' : ''}`}>
                                        {isLeader && <LucideCrown className="absolute -top-3 -left-2 w-6 h-6 text-yellow-400 fill-yellow-400 transform -rotate-12 drop-shadow-md"/>}
                                        <div className="flex justify-between items-center mb-2"><span className={`font-bold text-lg ${isBuzzer ? 'text-white' : 'text-slate-200'}`}>{p.name}</span>{roomData.hostId === p.id && <span className="text-[0.65rem] bg-yellow-600 text-yellow-100 px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">HOST</span>}</div>
                                        <div className="flex justify-between items-end"><span className={`text-3xl font-black font-mono leading-none ${p.score <= 0 ? 'text-red-500' : isLeader ? 'text-yellow-400' : 'text-blue-400'}`}>{p.score}</span><div className="flex flex-col items-end">{buzzerId === p.id && <span className="text-xs text-red-400 animate-pulse font-bold flex items-center gap-1"><LucideZap className="w-3 h-3"/>搶答中</span>}{p.ready ? <LucideCheckCircle className="w-5 h-5 text-blue-500"/> : !isPlaying && !isResolving && <span className="text-xs text-slate-500">等待準備</span>}</div></div>
                                    </div>
                                )
                            })}
                        </div>
                        <div className="space-y-3">
                            {!isPlaying && !isResolving && <button onClick={toggleReady} className={`w-full py-4 rounded-xl font-black text-xl shadow-lg transition-all border-2 ${myPlayer.ready ? 'bg-red-900/20 border-red-800 text-red-400 hover:bg-red-900/40' : 'bg-blue-600 border-blue-400 text-white hover:bg-blue-500 hover:border-blue-300 hover:shadow-blue-500/30'}`}>{myPlayer.ready ? '取消準備' : '準備就緒'}</button>}
                            {!isPlaying && !isResolving && isHost && <button onClick={startGame} className="w-full bg-gradient-to-r from-yellow-500 to-yellow-700 text-slate-900 py-4 rounded-xl font-black text-xl shadow-lg hover:from-yellow-400 hover:to-yellow-600 hover:shadow-yellow-500/30 disabled:opacity-30 disabled:cursor-not-allowed border-2 border-yellow-400 transition-all" disabled={!Object.values(roomData.players).every(p => p.ready)}>開始比賽</button>}
                            <button onClick={leaveRoom} className="w-full py-2 text-slate-500 text-sm hover:text-slate-300 transition flex items-center justify-center gap-1"><LucideXCircle className="w-4 h-4"/> 離開房間</button>
                        </div>
                    </div>

                    <div className="flex-1 p-6 flex flex-col items-center relative">
                        {isPlaying && (
                            <div className="w-full max-w-3xl mb-10 relative">
                                <div className="absolute inset-0 bg-slate-800/50 rounded-2xl skew-x-[-10deg] border border-slate-700"></div>
                                <div className={`absolute inset-0 rounded-2xl skew-x-[-10deg] opacity-30 transition-all duration-1000 ease-linear ${buzzerId ? 'bg-red-600' : 'bg-blue-600'}`} style={{ width: `${Math.min(100, (timeLeft / totalTime) * 100)}%` }}></div>
                                <div className="relative flex justify-between items-center p-4 px-8 z-10">
                                    <div className="flex items-center gap-3">
                                        <div className={`p-2 rounded-lg ${timeLeft <= 10 ? 'bg-red-500/20 text-red-400 animate-pulse' : 'bg-blue-500/20 text-blue-400'}`}><LucideTimer className="w-8 h-8" /></div>
                                        <div className="flex flex-col"><span className={`text-5xl font-black font-mono leading-none tracking-tighter ${timeLeft <= 10 ? 'text-red-400 drop-shadow-[0_0_10px_rgba(239,68,68,0.8)]' : 'text-white'}`}>{timeLeft.toString().padStart(2, '0')}<span className="text-2xl">s</span></span></div>
                                    </div>
                                    <div className="text-right">
                                        {buzzerId ? ( iAmBuzzer ? <div className="animate-pulse"><div className="text-yellow-400 font-bold text-2xl italic">你的回合!</div><div className="text-yellow-200/70 text-sm">請計算出 24</div></div> : <div><div className="text-red-400 font-bold text-2xl italic flex items-center gap-2 justify-end"><LucideZap className="w-5 h-5"/> {buzzerPlayer?.name} 搶答中</div><div className="text-red-200/70 text-sm">等待對手作答...</div></div> ) : ( <div><div className="text-blue-300 font-bold text-xl italic">自由搶答階段</div><div className="text-blue-200/50 text-sm">觀察卡牌，準備搶分</div></div> )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {isPlaying ? (
                            <div className="flex flex-col items-center w-full max-w-4xl z-10">
                                <div className={`grid grid-cols-4 gap-4 md:gap-8 mb-12 transition-all duration-500 ${buzzerId && !iAmBuzzer ? 'opacity-30 grayscale scale-95 blur-sm pointer-events-none' : ''}`}>
                                    {roomData.gameState.currentCards.map((card, idx) => (
                                        <Card key={idx} index={idx} cardId={card} onClick={iAmBuzzer ? (i) => { if(usedCardIndices.includes(i)) return; setUsedCardIndices([...usedCardIndices, i]); const details = getCardDetails(roomData.gameState.currentCards[i]); setExpression([...expression, { type: 'num', val: details.value, label: details.value }]); } : null} used={iAmBuzzer && usedCardIndices.includes(idx)} disabled={!!buzzerId && !iAmBuzzer} />
                                    ))}
                                </div>

                                {!buzzerId && (
                                    <div className="flex flex-col gap-6 w-full max-w-md animate-in fade-in zoom-in duration-300">
                                        <button onClick={buzz} className="group relative w-full bg-gradient-to-b from-red-500 to-red-700 hover:from-red-400 hover:to-red-600 active:from-red-700 active:to-red-800 text-white font-black py-8 rounded-3xl shadow-[0_12px_0_rgb(127,29,29),0_20px_30px_rgba(220,38,38,0.5)] active:shadow-[0_4px_0_rgb(127,29,29),0_5px_10px_rgba(220,38,38,0.3)] active:translate-y-2 transition-all border-4 border-red-400 overflow-hidden">
                                            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_rgba(255,255,255,0.4)_0%,_transparent_70%)] opacity-0 group-hover:opacity-100 transition duration-500 animate-pulse"></div>
                                            <span className="absolute inline-flex h-full w-full rounded-3xl bg-red-400 opacity-30 animate-ping inset-0 z-0"></span>
                                            <span className="relative z-10 flex items-center justify-center gap-3 text-5xl italic tracking-widest drop-shadow-lg"><LucideZap className="w-12 h-12 fill-white"/> 搶答!</span>
                                        </button>
                                        <div className="flex justify-center">
                                            <button onClick={voteImpossible} disabled={roomData.gameState.impossibleVotes?.includes(user.uid)} className={`flex items-center gap-2 px-8 py-3 rounded-full text-sm font-bold transition-all border-2 ${roomData.gameState.impossibleVotes?.includes(user.uid) ? 'bg-slate-800 text-slate-400 border-slate-700 cursor-not-allowed' : 'bg-slate-800/50 text-blue-300 border-blue-500/50 hover:bg-blue-900/30 hover:border-blue-400 hover:text-blue-200 hover:shadow-[0_0_15px_rgba(59,130,246,0.3)]'}`}>
                                                <LucideXCircle className="w-4 h-4"/>{roomData.gameState.impossibleVotes?.includes(user.uid) ? '已投票無解' : '這題無解 (投票)'} <span className="ml-2 bg-slate-900/80 px-3 py-0.5 rounded-full font-mono border border-slate-700">{roomData.gameState.impossibleVotes?.length || 0} / {Object.keys(roomData.players).length}</span>
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {iAmBuzzer && (
                                    <div className="w-full max-w-2xl bg-slate-800/90 backdrop-blur-xl rounded-3xl p-6 shadow-[0_20px_50px_rgba(0,0,0,0.5)] border-2 border-slate-700 animate-in slide-in-from-bottom-10 duration-300 relative z-20">
                                        <div className="flex items-center gap-2 mb-4 text-yellow-400"><LucideCalculator className="w-6 h-6"/><h3 className="text-xl font-bold italic">計算公式</h3></div>
                                        <div className="bg-black/60 border-2 border-slate-700 inset-shadow-sm p-6 rounded-2xl text-center text-3xl font-mono mb-6 min-h-[5rem] flex items-center justify-center flex-wrap gap-3 shadow-inner relative overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-b from-blue-500/5 to-transparent pointer-events-none"></div>
                                            {expression.length === 0 ? <span className="text-slate-600 text-lg italic animate-pulse">請點擊上方卡牌與下方符號...</span> : expression.map((t, i) => (<span key={i} className={`px-3 py-1 rounded-lg shadow-sm border ${t.type === 'op' ? 'bg-blue-900/50 text-blue-300 border-blue-800 font-black' : 'bg-slate-200 text-slate-900 border-slate-300 font-bold font-serif'}`}>{t.label}</span>))}
                                        </div>
                                        <div className="grid grid-cols-4 md:grid-cols-8 gap-3 mb-6">
                                            {/* FIX: Map * to × and / to ÷ for display */}
                                            {['+', '-', '*', '/', '(', ')'].map(op => ( <button key={op} onClick={() => { playSound('click'); setExpression([...expression, { type: 'op', val: op, label: op === '*' ? '×' : op === '/' ? '÷' : op }]) }} className="bg-slate-700 hover:bg-blue-600 text-blue-100 border border-slate-600 border-b-4 hover:border-blue-800 active:border-b-0 active:translate-y-1 font-black py-4 rounded-xl text-2xl transition-all shadow-md">{op === '*' ? '×' : op === '/' ? '÷' : op}</button> ))}
                                            <button onClick={() => { playSound('click'); if(expression.length === 0) return; const last = expression[expression.length - 1]; if (last.type === 'num') { setUsedCardIndices(prev => { const newArr = [...prev]; newArr.pop(); return newArr; }); } setExpression(expression.slice(0, -1)); }} className="bg-yellow-600/80 hover:bg-yellow-600 text-yellow-100 border-b-4 border-yellow-800 active:border-b-0 active:translate-y-1 font-bold py-4 rounded-xl text-xl transition-all shadow-md">←</button>
                                            <button onClick={() => { playSound('click'); setExpression([]); setUsedCardIndices([]); }} className="bg-red-600/80 hover:bg-red-600 text-red-100 border-b-4 border-red-800 active:border-b-0 active:translate-y-1 font-bold py-4 rounded-xl text-xl transition-all shadow-md">C</button>
                                        </div>
                                        <button onClick={submitAnswer} disabled={expression.length === 0} className="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-400 hover:to-green-600 text-white font-black py-5 rounded-2xl text-2xl shadow-lg hover:shadow-green-500/30 border-2 border-green-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">確認提交 (= 24)</button>
                                    </div>
                                )}
                            </div>
                        ) : (
                            !isResolving && <div className="flex-1 flex flex-col items-center justify-center text-slate-400 opacity-80 animate-pulse"><LucideGamepad2 className="w-32 h-32 mb-6 text-slate-600" /><h3 className="text-3xl font-black italic text-slate-300 mb-2">等待賽事開始...</h3><p className="text-lg flex items-center gap-2"><LucideCrown className="w-5 h-5 text-yellow-600"/> HOST 需按下開始按鈕</p></div>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(Math24Game));
    </script>
</body>
</html>
